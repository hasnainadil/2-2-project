CREATE OR REPLACE PROCEDURE "MEALPLAN_RECIPES" (U_ID IN NUMBER, PL_ID IN NUMBER, STATUS OUT VARCHAR2,RECIPES_CR OUT SYS_REFCURSOR) AS
BEGIN
	OPEN RECIPES_CR FOR
SELECT
	*
FROM
	(
	SELECT
		R.RECIPE_ID,
		R.TITLE,
		MPR.MEAL_SLOT,
		( SELECT ( FIRST_NAME || ' ' || LAST_NAME ) AS NAME FROM USERS WHERE USER_ID = R.USER_ID ) AS PUBLISHER_NAME,
		TO_CHAR( R.CREATION_DATE, 'DD/MON/YY' ) CREATION_DATE
	FROM
		RECIPES R
		JOIN MEAL_PLAN_RECIPES MPR ON ( R.RECIPE_ID = MPR.RECIPE_ID )
		JOIN MEAL_PLANS MP ON (MP.PLAN_ID = MPR.PLAN_ID)
	WHERE
		MP.USER_ID = U_ID AND MP.PLAN_ID = PL_ID
	ORDER BY
		R.TITLE
	);
STATUS := 'SUCCESSFUL';
EXCEPTION
	WHEN NO_DATA_FOUND THEN
	STATUS := 'NO DATA FOUND';
	WHEN OTHERS THEN
	STATUS := 'UNKNOWN ERROR';
END;
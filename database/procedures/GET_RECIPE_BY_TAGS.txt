CREATE OR REPLACE PROCEDURE get_recipe_by_tags(
  tag_ids_csv IN VARCHAR2,
	category_ids_csv IN VARCHAR2,
  recipe_cursor OUT SYS_REFCURSOR,
	STATUS OUT VARCHAR2
) AS
BEGIN
   OPEN recipe_cursor FOR
	 SELECT * FROM
	 (SELECT DISTINCT RT.RECIPE_ID , ( SELECT TITLE FROM RECIPES WHERE RECIPE_ID = RT.RECIPE_ID ) as TITLE,(SELECT (FIRST_NAME||' '||LAST_NAME) FROM USERS WHERE USER_ID = (SELECT USER_ID FROM RECIPES WHERE RECIPE_ID = RT.RECIPE_ID)) AS PUBLISHER_NAME, (SELECT TO_CHAR(CREATION_DATE,'DD/MON/YY') FROM RECIPES WHERE RECIPE_ID = RT.RECIPE_ID) CREATION_DATE, (SELECT COOKING_INSTRUCTION FROM RECIPES WHERE RECIPE_ID = RT.RECIPE_ID) COOKING_INSTRUCTION ,AVERAGE_RATING(RT.RECIPE_ID) as RATING,(SELECT IMAGE FROM MEDIA WHERE RECIPE_ID = RT.RECIPE_ID)AS IMAGE
	 
	 FROM RECIPE_TAGS RT  WHERE TAG_ID IN (SELECT TO_NUMBER(REGEXP_SUBSTR(tag_ids_csv, '[^,]+', 1, LEVEL)) FROM DUAL CONNECT BY REGEXP_SUBSTR(tag_ids_csv, '[^,]+', 1, LEVEL) IS NOT NULL) ORDER BY ( SELECT TITLE FROM RECIPES WHERE RECIPE_ID = RT.RECIPE_ID ))
	 UNION
	 SELECT * FROM
	(SELECT DISTINCT RT.RECIPE_ID , ( SELECT TITLE FROM RECIPES WHERE RECIPE_ID = RT.RECIPE_ID ) as TITLE,(SELECT (FIRST_NAME||' '||LAST_NAME) FROM USERS WHERE USER_ID = (SELECT USER_ID FROM RECIPES WHERE RECIPE_ID = RT.RECIPE_ID)) AS PUBLISHER_NAME, (SELECT TO_CHAR(CREATION_DATE,'DD/MON/YY') FROM RECIPES WHERE RECIPE_ID = RT.RECIPE_ID) CREATION_DATE, (SELECT COOKING_INSTRUCTION FROM RECIPES WHERE RECIPE_ID = RT.RECIPE_ID) COOKING_INSTRUCTION ,AVERAGE_RATING(RT.RECIPE_ID) as RATING,(SELECT IMAGE FROM MEDIA WHERE RECIPE_ID = RT.RECIPE_ID)AS IMAGE
	
	FROM CATEGORIZES RT WHERE CATEGORY_ID IN (SELECT TO_NUMBER(REGEXP_SUBSTR(category_ids_csv, '[^,]+', 1, LEVEL)) FROM DUAL CONNECT BY REGEXP_SUBSTR(category_ids_csv, '[^,]+', 1, LEVEL) IS NOT NULL) ORDER BY ( SELECT TITLE FROM RECIPES WHERE RECIPE_ID = RT.RECIPE_ID ));
	
	 STATUS := 'SUCCESSFUL';
	 EXCEPTION
	WHEN NO_DATA_FOUND THEN
	STATUS := 'NO DATA FOUND';
	WHEN OTHERS THEN
	STATUS := 'UNKNOWN ERROR';
END;
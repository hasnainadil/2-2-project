CREATE OR REPLACE PROCEDURE "DIETRY_RECIPES" (ID IN NUMBER, ROW_LIMIT IN NUMBER,STATUS OUT VARCHAR2,RECIPES_CR OUT SYS_REFCURSOR) AS
BEGIN
	OPEN RECIPES_CR FOR
SELECT
	*
FROM
	(
	SELECT DISTINCT
		R.RECIPE_ID,
		R.TITLE,
		( SELECT ( FIRST_NAME || ' ' || LAST_NAME ) AS NAME FROM USERS WHERE USER_ID = R.USER_ID ) AS PUBLISHER_NAME,
		TO_CHAR( R.CREATION_DATE, 'DD/MON/YY' ) CREATION_DATE
	FROM
		RECIPES R
		JOIN RECIPE_TAGS RT ON ( R.RECIPE_ID = RT.RECIPE_ID )
	WHERE
		RT.TAG_ID IN (
		SELECT
			T.TAG_ID
		FROM
			USERS U
			JOIN USER_DIETARY_RESTRICTIONS UDR ON ( UDR.USER_ID = U.USER_ID )
			JOIN DIETARY_RESTRICTIONS DR ON ( UDR.DIETARY_ID = DR.DIETARY_ID )
			JOIN TAGS T ON ( T.NAME LIKE DR.RESTRICTION )
		WHERE
			U.USER_ID = ID
		)
	ORDER BY
		R.TITLE
	);
STATUS := 'SUCCESSFUL';
EXCEPTION
	WHEN NO_DATA_FOUND THEN
	STATUS := 'NO DATA FOUND';
	WHEN OTHERS THEN
	STATUS := 'UNKNOWN ERROR';
END;
CREATE OR REPLACE PROCEDURE "RECIPE_DETAILS"(ID IN NUMBER,STATUS OUT VARCHAR2,RECIPES_CR OUT SYS_REFCURSOR,INGREDIENTS_CR OUT SYS_REFCURSOR,CATEGORIES_CR OUT SYS_REFCURSOR,TAGS_CR OUT SYS_REFCURSOR,REVIEWS_CR OUT SYS_REFCURSOR,MEDIA_CR OUT SYS_REFCURSOR, SUB_INGREDIENT_CR OUT SYS_REFCURSOR, NEUTRITION_CR OUT SYS_REFCURSOR,IS_FAV OUT VARCHAR2,TEMP_USER_ID IN NUMBER) AS
BEGIN
OPEN RECIPES_CR FOR 
SELECT RECIPE_ID, TITLE , COOKING_INSTRUCTION,PREPARATION_TIME,COOKING_TIME,(SELECT (FIRST_NAME||' '||LAST_NAME) AS NAME FROM USERS WHERE USER_ID = R.USER_ID) AS NAME,TO_CHAR(CREATION_DATE,'DD/MON/YY') CREATION_DATE,TO_CHAR(MODIFICATION_DATE,'DD/MON/YY') MODIFICATION_DATE,AVERAGE_RATING(ID) AS RATING ,(SELECT COUNT(*) from FAVOURITE WHERE RECIPE_ID = R.RECIPE_ID) FAVOURITE_OF
FROM RECIPES R WHERE RECIPE_ID = ID;

OPEN INGREDIENTS_CR FOR 
SELECT *
FROM INGREDIENTS
WHERE INGREDIENT_ID IN ( SELECT INGREDIENT_ID
FROM RECIPE_INGREDIENTS WHERE RECIPE_ID = ID);

OPEN CATEGORIES_CR FOR 
SELECT *
FROM CATEGORIES
WHERE CATEGORY_ID IN (SELECT CATEGORY_ID
FROM CATEGORIZES WHERE RECIPE_ID = ID);

OPEN TAGS_CR FOR
SELECT *
FROM TAGS 
WHERE TAG_ID IN( SELECT TAG_ID
FROM RECIPE_TAGS WHERE RECIPE_ID = ID);

OPEN REVIEWS_CR FOR 
SELECT REVIEW_ID,(SELECT (FIRST_NAME||' '||LAST_NAME) AS NAME FROM USERS WHERE USER_ID = R.USER_ID) AS NAME,RECIPE_ID,RATING,COMMENTS,TO_CHAR(REVIEW_DATE,'DD/MON/YY') REVIEW_DATE
FROM REVIEWS R
WHERE RECIPE_ID = ID;

OPEN MEDIA_CR FOR 
SELECT * 
FROM MEDIA
WHERE RECIPE_ID = ID;

OPEN SUB_INGREDIENT_CR FOR 
SELECT (SELECT NAME FROM INGREDIENTS WHERE INGREDIENT_ID = ORIGINAL_INGREDIENT_ID) AS INGREDIENT_NAME, (SELECT NAME FROM INGREDIENTS WHERE INGREDIENT_ID = SUBSTITUTE_INGREDIENT_ID) AS SUBSTITUTION
FROM SUBSTITUTIONS
WHERE ORIGINAL_INGREDIENT_ID IN(
SELECT INGREDIENT_ID
FROM INGREDIENTS
WHERE INGREDIENT_ID IN ( SELECT INGREDIENT_ID
FROM RECIPE_INGREDIENTS WHERE RECIPE_ID = ID)
);

OPEN NEUTRITION_CR FOR 

SELECT SUM(I.CALORIES * RI.QUANTITY) AS CALORIES,
           SUM(I.PROTEIN * RI.QUANTITY) AS PROTEIN ,
           SUM(I.CARBOHYDRATE * RI.QUANTITY) AS CARBOHYDRATE,
           SUM(I.FAT * RI.QUANTITY) AS FAT,
           SUM(I.FIBER * RI.QUANTITY) AS FIBER
    FROM RECIPES R
    JOIN RECIPE_INGREDIENTS RI ON R.RECIPE_ID = RI.RECIPE_ID
    JOIN INGREDIENTS I ON RI.INGREDIENT_ID = I.INGREDIENT_ID
    WHERE R.RECIPE_ID = ID;
	
IS_FAV := 'FALSE';
FOR R IN (SELECT RECIPE_ID FROM FAVOURITE WHERE USER_ID = TEMP_USER_ID)
LOOP
IF ID = R.RECIPE_ID THEN
 IS_FAV := 'TRUE';
END IF;
END LOOP;


STATUS := 'SUCCESSFUL';

EXCEPTION
	WHEN NO_DATA_FOUND THEN
	STATUS := 'NO DATA FOUND';
	WHEN OTHERS THEN
	STATUS := 'UNKNOWN ERROR';

END;
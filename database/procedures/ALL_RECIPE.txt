CREATE OR REPLACE PROCEDURE "ALL_RECIPE"(RECIPE_NUM IN NUMBER,SEARCH IN VARCHAR2,TOTAL_COUNT OUT NUMBER,STATUS OUT VARCHAR2,RECIPES_CR OUT SYS_REFCURSOR) AS
BEGIN
	-- routine body goes here, e.g.
	-- DBMS_OUTPUT.PUT_LINE('Navicat for Oracle');
	IF RECIPE_NUM = 0 THEN 
	OPEN RECIPES_CR FOR 
			SELECT RECIPE_ID, TITLE, (SELECT (FIRST_NAME||' '||LAST_NAME) AS NAME FROM USERS WHERE USER_ID = R.USER_ID) as PUBLISHER_NAME,TO_CHAR(CREATION_DATE,'DD/MON/YY') CREATION_DATE , COOKING_INSTRUCTION ,AVERAGE_RATING(RECIPE_ID) as RATING,(SELECT IMAGE FROM MEDIA WHERE RECIPE_ID = R.RECIPE_ID)AS IMAGE
		FROM RECIPES R
		WHERE LOWER(TITLE) LIKE '%'||LOWER(SEARCH)||'%'
		ORDER BY TITLE;
	ELSE
	OPEN RECIPES_CR FOR 
	SELECT * FROM(
			SELECT RECIPE_ID, TITLE, (SELECT (FIRST_NAME||' '||LAST_NAME) AS NAME FROM USERS WHERE USER_ID = R.USER_ID) as PUBLISHER_NAME,TO_CHAR(CREATION_DATE,'DD/MON/YY') CREATION_DATE , COOKING_INSTRUCTION ,AVERAGE_RATING(RECIPE_ID) as RATING,(SELECT IMAGE FROM MEDIA WHERE RECIPE_ID = R.RECIPE_ID)AS IMAGE
		FROM RECIPES R
		WHERE LOWER(TITLE) LIKE '%'||LOWER(SEARCH)||'%' 
		ORDER BY AVERAGE_RATING(RECIPE_ID))
		WHERE ROWNUM <= RECIPE_NUM;
		END IF;
		SELECT COUNT(*) INTO TOTAL_COUNT FROM RECIPES WHERE LOWER(TITLE) LIKE '%'||LOWER(SEARCH)||'%';
	STATUS := 'SUCCESSFUL';
EXCEPTION
	WHEN NO_DATA_FOUND THEN
	STATUS := 'NO DATA FOUND';
	WHEN OTHERS THEN
	STATUS := 'UNKNOWN ERROR';
END;